"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const t=(t,e)=>Object.assign({},t,e),e=t=>{console.info(`[cbd -- A/B test sdk] ${t}`)},n=t=>"string"==typeof t&&t.constructor==String,r=t=>"[object Function]"===Object.prototype.toString.call(t)||"[object AsyncFunction]"===Object.prototype.toString.call(t);function i(t){return null!=t&&"[object Object]"==toString.call(t)}const s=Array.isArray||function(t){return"[object Array]"===toString.call(t)};function o(t){const e={};return function t(e,n){for(const r in n){const o=n[r];s(o)?(e[r]=[],t(e[r],o)):i(o)?(e[r]={},t(e[r],o)):e[r]=o}}(e,t),e}let a=null;const u=async t=>(a=t,a);async function c(t){const e=await function(t,e={}){return new Promise((n=>{a.then((r=>{r.default(t,{params:e},!1).then((t=>{t&&200===t.code&&t.data&&t.data.length>0?n(t.data):(n(void 0),console.warn(t.msg))})).catch((t=>{n(void 0),console.warn("Request error:",t)}))}))}))}("experiment/config/list",t);return e}var f;exports.ENV=void 0,(f=exports.ENV||(exports.ENV={})).WEB="web",f.MINI_WECHAT="mini-wechat",f.MINI_DOUYIN="mini-douyin";const p={appKey:void 0,auto_report:!1,reportChannel:"cn",log:!1,enableAbTest:!0,clear_ab_cache_on_user_change:!1,customConfig:{},autoRefresh:!1,autoRefreshStep:0,userId:""},l=(e,n=e)=>t(n,e);var h=function(t,e){return t.reduce((function(t,n){var r="[object "+n+"]";return e?t[r]=n:t[n]=r,t}),{})},g=function(t){return t.reduce((function(t,e){return t[e]=!0,t}),{})},d=["Array","Arguments","Object","RegExp","Symbol","Map","Set","Date","Error","Event","Generator","Promise","WeakMap","WeakSet","DocumentFragment","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","ArrayBuffer","DataView","DocumentFragment","Window","String","Number","Boolean","Function","Undefined","GeneratorFunction","BigInt","Null"],y=h(d,!1),m=h(d,!0),x=g([y.Generator,y.Promise,y.WeakMap,y.WeakSet]),v=g([y.Map,y.Set]),b=g([y.Date,y.RegExp]),A=g(["bigint","boolean","function","number","string","undefined"]),C=g([y.Arguments,y.Array]),I=g([y.RegExp,y.Symbol]),O=g([y.Float32Array,y.Float64Array,y.Int8Array,y.Int16Array,y.Int32Array,y.Uint8Array,y.Uint8ClampedArray,y.Uint16Array,y.Uint32Array]),E="undefined"!=typeof Buffer&&"function"==typeof Buffer.from,k="function"==typeof Uint16Array;function j(t){return String.fromCharCode.apply(null,new Uint16Array(t))}function T(t){return Buffer.from(t).toString("utf8")}function w(t){return""}var R=E?T:k?j:w,S=/\[object ([HTML|SVG](.*)Element)\]/,N=Object.prototype.toString,M=Object.keys;function U(t,e){return t>e}function _(t,e){return t[0]>e[0]}function P(t,e){for(var n,r,i=0;i<t.length;++i){for(r=t[i],n=i-1;~n&&e(t[n],r);--n)t[n+1]=t[n];t[n+1]=r}return t}function V(t){for(var e,n=P(M(t),U),r={},i=0;i<n.length;++i)r[e=n[i]]=t[e];return r}function B(t,e){for(var n=0;n<t.length;++n)if(t[n]===e)return n+1;return 0}function F(t,e,n,r){if(!r){var i=typeof t;if(A[i])return i+"|"+t;if(null===t)return t+"|"+t}var s,o=r||N.call(t);return C[o]?t:o===y.Object?V(t):I[o]?m[o]+"|"+t.toString():v[o]?t instanceof Map?function(t,e,n){var r=[];t.forEach((function(t,i){r.push([D(i,e,n),D(t,e,n)])})),P(r,_);for(var i,s=0;s<r.length;++s)i=r[s],r[s]="["+i[0]+","+i[1]+"]";return"Map|["+r.join(",")+"]"}(t,e,n):function(t,e,n){var r=[];return t.forEach((function(t){r.push(D(t,e,n))})),P(r,U),"Set|["+r.join(",")+"]"}(t,e,n):o===y.Date?m[o]+"|"+t.getTime():o===y.Error?m[o]+"|"+t.stack:o===y.Event?{bubbles:(s=t).bubbles,cancelBubble:s.cancelBubble,cancelable:s.cancelable,composed:s.composed,currentTarget:s.currentTarget,defaultPrevented:s.defaultPrevented,eventPhase:s.eventPhase,isTrusted:s.isTrusted,returnValue:s.returnValue,target:s.target,type:s.type}:x[o]?m[o]+"|NOT_ENUMERABLE":S.test(o)?o.slice(8,-1)+"|"+t.outerHTML:o===y.DocumentFragment?m[o]+"|"+function(t){for(var e=t.children,n=[],r=0;r<e.length;++r)n.push(e[r].outerHTML);return n.join(",")}(t):O[o]?m[o]+"|"+t.join(","):o===y.ArrayBuffer?m[o]+"|"+R(t):o===y.DataView?m[o]+"|"+R(t.buffer):t}function D(t,e,n){if(!t||"object"!=typeof t)return F(t,e,n);var r=N.call(t);return b[r]?F(t,e,n,r):JSON.stringify(t,function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=[]),function(n,r){if("object"==typeof r)if(t.length){var i=B(t,this);0===i?t.push(this):(t.splice(i),e.splice(i)),e.push(n);var s=B(t,r);if(0!==s)return"[~"+(e.slice(0,s).join(".")||".")+"]";t.push(r)}else t[0]=r,e[0]=n;return n&&this[n]instanceof Date?F(this[n],t,e,y.Date):F(r,t,e)}}(e,n))}function W(t){return function(t){for(var e,n=t.length,r=5381,i=52711;n--;)r=33*r^(e=t.charCodeAt(n)),i=33*i^e;return 4096*(r>>>0)+(i>>>0)}(D(t))}function z(t,e){return W(t)===W(e)}z.all=function(t){for(var e=0;e<(arguments.length<=1?0:arguments.length-1);++e)if(!z(t,e+1<1||arguments.length<=e+1?void 0:arguments[e+1]))return!1;return!0},z.any=function(t){for(var e=0;e<(arguments.length<=1?0:arguments.length-1);++e)if(z(t,e+1<1||arguments.length<=e+1?void 0:arguments[e+1]))return!0;return!1},z.not=function(t,e){return W(t)!==W(e)},W.is=z;const H=t=>{const e=t.expConfig,n={};return e.forEach((e=>{const r=K(t.configOption.userId,e.experimentTrafficWeight);n[e.experimentId]={...e,...r}})),n},K=(t,e)=>{const n=Math.abs(W(t))%1e3/10;return{isEntry:n<=e,hashVal:n}},q=(t,e)=>{let n=0;const r=e,i=r.hashVal*(100/r.experimentTrafficWeight),s={msg:"group successfully",res:{isEntryVersion:!1,versionId:0,versionParam:{}}};for(let e=0;e<r.versions.length;e++)if(n+=r.versions[e].versionTrafficWeight,i<n&&(!r.versions[e].whitelist||r.versions[e].whitelist.indexOf(t.configOption.userId)<0)){s.res={isEntryVersion:!0,versionId:r.versions[e].versionId,versionParam:r.versions[e].versionParam};break}return s},G={configOption:{},log:!1,expConfig:[],timer:0,isInit:!1,shuntRes:{},groupRes:{},getExpConfig:Function,init(t,n){this.log&&e("init running"),this.getExpConfig=n||$,this.configOption=l(t,p),this.log=this.configOption.log,this.isInit=!0},async start(t){return this.isInit?(this.log&&e("start running"),this.expConfig=await this.getExpConfig(this.configOption.appKey,this),this.configOption.autoRefresh&&Q(this),this.expConfig?(this.shuntRes=H(this),this.log&&e("shunt successfully"),t&&t({res:{expConfig:this.expConfig,shuntRes:this.shuntRes,sdk:this},msg:"shunt successfully",status:!0})):t&&t({res:{expConfig:{},shuntRes:{},sdk:this},msg:"unknown exception",status:!1})):(t&&t({res:void 0,msg:"sdk not initialized",status:!1}),void(this.log&&e("sdk not initialized")))},getVar(t,n,r){if(!this.isInit)return r&&r({res:void 0,msg:"sdk not initialized",status:!1}),void(this.log&&e("sdk not initialized"));this.log&&e("getVar running");const i=this.shuntRes[t];i&&i.isEntry&&(this.groupRes=q(this,i),this.log&&e("group successfully"),r&&r(this.groupRes)),i&&!i.isEntry&&(this.log&&e("user did not enter the experiment"),r&&r({res:n,msg:"user did not enter the experiment",status:!1})),i&&0!==this.expConfig.length||(this.log&&e("unknown exception"),r&&r({res:n,msg:"unknown exception",status:!1}))},config(t,n){if(!this.isInit)return n&&n({res:void 0,msg:"sdk not initialized",status:!1}),void(this.log&&e("sdk not initialized"));this.configOption=l(t,this.configOption),this.log&&e("config set success !")},async refresh(t){return this.isInit?(this.expConfig=await this.getExpConfig(this.configOption.appKey,this),this.expConfig?(this.shuntRes=H(this),this.log&&e("shunt successfully"),t&&t({res:{expConfig:this.expConfig,shuntRes:this.shuntRes,sdk:this},msg:"shunt successfully",status:!0})):void 0):(t&&t({res:void 0,msg:"sdk not initialized",status:!1}),void(this.log&&e("sdk not initialized")))},resetInstance(){this.configOption={},this.log=!1,this.expConfig=[],this.timer&&clearTimeout(this.timer),this.timer=0,this.isInit=!1,this.shuntRes={},this.groupRes={}}},L=new Map;function Y(t,...e){let r="",i="";if(n(t)?r=t:(r=t.funcName,i=t.sdkKey),i){if(!L.get(i)&&"init"===r){const t=J(r,G,...e);return L.set(i,o(G)),t}return L.get(i)||"init"===r?J(r,L.get(i),...e):{res:{expConfig:{},shuntRes:{},sdk:L.get(i)},msg:"sdkKey does not exist"}}return J(r,G,...e)}const J=(t,e,...n)=>"start"===t||"refresh"===t?new Promise((r=>{e[t].call(e,r,...n)})):(e[t]&&r(e[t])&&e[t].call(e,...n),e),$=async(t,n)=>{const r={appKey:t},i=await c(r);if(i)return n.log&&e("The experimental parameters were successfully obtained"),i;n.log&&e("Failed to get experimental parameters")},Q=t=>{const e=t.configOption.autoRefreshStep;t.timer=setInterval((async()=>{t.refresh()}),e)};u(Promise.resolve().then((function(){return st})));var X,Z;!function(t){t.json="application/json;charset=UTF-8"}(X||(X={})),function(t){t.post="POST"}(Z||(Z={}));const et=t=>t&&void 0!==t["Content-Type"]?t["Content-Type"]:(t&&(t.method,Z.post),X.json),nt=t=>`http://47.96.100.195/api/${t.replace("//","/")}`,rt=(t,e)=>{const n=e&&void 0!==e.token?e.token:"",r="mini-wechat";return r===exports.ENV.MINI_WECHAT||r===exports.ENV.MINI_DOUYIN?{token:n,"Content-Type":t}:new Headers({token:n,"Content-Type":t})};const it=t=>t;var st=Object.freeze({__proto__:null,default:async(t,n={params:{},method:"POST",headers:{"Content-Type":X.json,token:""},token:"","Content-Type":X.json})=>{const{reqUrl:r,headers:i}=function(t,e){const n=et(e);return{contentType:n,reqUrl:nt(t),headers:rt(n,e)}}(t,n),s=await function(t,n,r){return new Promise(((i,s)=>{("mini-wechat"===exports.ENV.MINI_DOUYIN?tt:wx).request({url:t,method:Z.post,data:r.params,header:{...n},success:t=>{200===t.statusCode?i(t.data):s(t)},fail:t=>{s(t),e(t.message)}})}))}(r,i,n);return it(s)}});exports.ABTest=(t,...e)=>Y(t,...e),exports.abTestGrouping=q,exports.abTestShunt=H,exports.autoRefresh=Q,exports.cbdABTest=Y,exports.deepCopy=o,exports.experimentConfig=c,exports.extend=t,exports.getExperimentConfig=$,exports.isArray=s,exports.isBool=t=>"boolean"==typeof t,exports.isEmptyObj=t=>"{}"===JSON.stringify(t),exports.isFunction=r,exports.isNumber=t=>"number"==typeof t,exports.isObject=i,exports.isString=n,exports.log=e,exports.mergeConfig=l,exports.sdk=G,exports.setConfig=function(t,e){Object.prototype.hasOwnProperty.call(p,t)?p[t]=e:p.customConfig[t]=e},exports.setRequestInst=u,exports.shuntAlgorithm=K;
