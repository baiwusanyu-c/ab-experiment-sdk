"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const t=(t,e)=>Object.assign({},t,e),e=t=>{console.info(`[cbd -- A/B test sdk] ${t}`)},n=t=>"string"==typeof t&&t.constructor==String,r=t=>"[object Function]"===Object.prototype.toString.call(t)||"[object AsyncFunction]"===Object.prototype.toString.call(t);function s(t){return null!=t&&"[object Object]"==toString.call(t)}const i=(t,e=Array.isArray)=>e?e(t):"[object Array]"===toString.call(t);function o(t){const e={};return function t(e,n){for(const r in n){const o=n[r];i(o)?(e[r]=[],t(e[r],o)):s(o)?(e[r]={},t(e[r],o)):e[r]=o}}(e,t),e}let a=null;const u=async t=>(a=t,a);async function c(t){const e=await function(t,e={}){return new Promise((n=>{a.then((r=>{r.default(t,{params:e},!1).then((t=>{t&&200===t.code&&t.data&&t.data.length>0?n(t.data):(n(void 0),console.warn(t.msg))})).catch((t=>{n(void 0),console.warn("Request error:",t)}))}))}))}("experiment/config/list",t);return e}var f;exports.ENV=void 0,(f=exports.ENV||(exports.ENV={})).WEB="web",f.MINI_WECHAT="mini-wechat",f.MINI_DOUYIN="mini-douyin",f.UNI_APP="uni-app";const p={appKey:void 0,auto_report:!1,reportChannel:"cn",log:!1,enableAbTest:!0,clear_ab_cache_on_user_change:!1,customConfig:{},autoRefresh:!1,autoRefreshStep:0,userId:""},h=(e,n=e)=>t(n,e);var l=function(t,e){return t.reduce((function(t,n){var r="[object "+n+"]";return e?t[r]=n:t[n]=r,t}),{})},g=function(t){return t.reduce((function(t,e){return t[e]=!0,t}),{})},d=["Array","Arguments","Object","RegExp","Symbol","Map","Set","Date","Error","Event","Generator","Promise","WeakMap","WeakSet","DocumentFragment","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","ArrayBuffer","DataView","DocumentFragment","Window","String","Number","Boolean","Function","Undefined","GeneratorFunction","BigInt","Null"],y=l(d,!1),m=l(d,!0),x=g([y.Generator,y.Promise,y.WeakMap,y.WeakSet]),v=g([y.Map,y.Set]),b=g([y.Date,y.RegExp]),A=g(["bigint","boolean","function","number","string","undefined"]),C=g([y.Arguments,y.Array]),I=g([y.RegExp,y.Symbol]),E=g([y.Float32Array,y.Float64Array,y.Int8Array,y.Int16Array,y.Int32Array,y.Uint8Array,y.Uint8ClampedArray,y.Uint16Array,y.Uint32Array]),O="undefined"!=typeof Buffer&&"function"==typeof Buffer.from,T="function"==typeof Uint16Array;function j(t){return String.fromCharCode.apply(null,new Uint16Array(t))}function k(t){return Buffer.from(t).toString("utf8")}function w(t){return""}var N=O?k:T?j:w,R=/\[object ([HTML|SVG](.*)Element)\]/,S=Object.prototype.toString,P=Object.keys;function _(t,e){return t>e}function U(t,e){return t[0]>e[0]}function M(t,e){for(var n,r,s=0;s<t.length;++s){for(r=t[s],n=s-1;~n&&e(t[n],r);--n)t[n+1]=t[n];t[n+1]=r}return t}function V(t){for(var e,n=M(P(t),_),r={},s=0;s<n.length;++s)r[e=n[s]]=t[e];return r}function B(t,e){for(var n=0;n<t.length;++n)if(t[n]===e)return n+1;return 0}function F(t,e,n,r){if(!r){var s=typeof t;if(A[s])return s+"|"+t;if(null===t)return t+"|"+t}var i,o=r||S.call(t);return C[o]?t:o===y.Object?V(t):I[o]?m[o]+"|"+t.toString():v[o]?t instanceof Map?function(t,e,n){var r=[];t.forEach((function(t,s){r.push([D(s,e,n),D(t,e,n)])})),M(r,U);for(var s,i=0;i<r.length;++i)s=r[i],r[i]="["+s[0]+","+s[1]+"]";return"Map|["+r.join(",")+"]"}(t,e,n):function(t,e,n){var r=[];return t.forEach((function(t){r.push(D(t,e,n))})),M(r,_),"Set|["+r.join(",")+"]"}(t,e,n):o===y.Date?m[o]+"|"+t.getTime():o===y.Error?m[o]+"|"+t.stack:o===y.Event?{bubbles:(i=t).bubbles,cancelBubble:i.cancelBubble,cancelable:i.cancelable,composed:i.composed,currentTarget:i.currentTarget,defaultPrevented:i.defaultPrevented,eventPhase:i.eventPhase,isTrusted:i.isTrusted,returnValue:i.returnValue,target:i.target,type:i.type}:x[o]?m[o]+"|NOT_ENUMERABLE":R.test(o)?o.slice(8,-1)+"|"+t.outerHTML:o===y.DocumentFragment?m[o]+"|"+function(t){for(var e=t.children,n=[],r=0;r<e.length;++r)n.push(e[r].outerHTML);return n.join(",")}(t):E[o]?m[o]+"|"+t.join(","):o===y.ArrayBuffer?m[o]+"|"+N(t):o===y.DataView?m[o]+"|"+N(t.buffer):t}function D(t,e,n){if(!t||"object"!=typeof t)return F(t,e,n);var r=S.call(t);return b[r]?F(t,e,n,r):JSON.stringify(t,function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=[]),function(n,r){if("object"==typeof r)if(t.length){var s=B(t,this);0===s?t.push(this):(t.splice(s),e.splice(s)),e.push(n);var i=B(t,r);if(0!==i)return"[~"+(e.slice(0,i).join(".")||".")+"]";t.push(r)}else t[0]=r,e[0]=n;return n&&this[n]instanceof Date?F(this[n],t,e,y.Date):F(r,t,e)}}(e,n))}function W(t){return function(t){for(var e,n=t.length,r=5381,s=52711;n--;)r=33*r^(e=t.charCodeAt(n)),s=33*s^e;return 4096*(r>>>0)+(s>>>0)}(D(t))}function H(t,e){return W(t)===W(e)}H.all=function(t){for(var e=0;e<(arguments.length<=1?0:arguments.length-1);++e)if(!H(t,e+1<1||arguments.length<=e+1?void 0:arguments[e+1]))return!1;return!0},H.any=function(t){for(var e=0;e<(arguments.length<=1?0:arguments.length-1);++e)if(H(t,e+1<1||arguments.length<=e+1?void 0:arguments[e+1]))return!0;return!1},H.not=function(t,e){return W(t)!==W(e)},W.is=H;const z=t=>{const e=t.expConfig,n={};return e.forEach((e=>{const r=K(t.configOption.userId,e.experimentTrafficWeight);n[e.experimentId]={...e,...r}})),n},K=(t,e)=>{const n=Math.abs(W(t))%1e3/10;return{isEntry:n<=e,hashVal:n}},q=(t,e,n)=>{let r=0;const s=e,i=s.hashVal*(100/s.experimentTrafficWeight),o={msg:"group successfully",res:{isEntryVersion:!1,versionId:0,versionParam:{}},status:!1};for(let e=0;e<s.versions.length;e++)if(r+=s.versions[e].versionTrafficWeight,i<r&&(!s.versions[e].whitelist||s.versions[e].whitelist.indexOf(t.configOption.userId)<0)){o.res={isEntryVersion:!0,versionId:s.versions[e].versionId,versionParam:s.versions[e].versionParam},o.status=!0;break}return o},G={configOption:{},log:!1,expConfig:[],timer:0,isInit:!1,shuntRes:{},groupRes:{},getExpConfig:Function,init(t,n){this.log&&e("init running"),this.getExpConfig=n||$,this.configOption=h(t,p),this.log=this.configOption.log,this.isInit=!0},async start(t){return this.isInit?(this.log&&e("start running"),this.expConfig=await this.getExpConfig(this.configOption.appKey,this),this.configOption.autoRefresh&&Q(this),this.expConfig&&0!==this.expConfig.length?(this.shuntRes=z(this),this.log&&e("shunt successfully"),t&&t({res:{expConfig:this.expConfig,shuntRes:this.shuntRes,sdk:this},msg:"shunt successfully",status:!0})):t&&t({res:{expConfig:[],shuntRes:{},sdk:this},msg:"unknown exception",status:!1})):(t&&t({res:void 0,msg:"sdk not initialized",status:!1}),void(this.log&&e("sdk not initialized")))},getVar(t,n,r){this.log&&e("getVar running");const s=this.shuntRes[t];if(s&&s.isEntry){const t=q(this,s);this.log&&e("group successfully"),t.status?(this.groupRes=t,r&&r(this.groupRes)):r&&r({res:n,msg:"user did not enter the version",status:!1})}s&&!s.isEntry&&(this.log&&e("user did not enter the experiment"),r&&r({res:n,msg:"user did not enter the experiment",status:!1})),s&&0!==this.expConfig.length||(this.log&&e("unknown exception"),r&&r({res:n,msg:"unknown exception",status:!1}))},config(t,n){this.configOption=h(t,this.configOption),this.log&&e("config set success !")},async refresh(t){return this.isInit?(this.expConfig=await this.getExpConfig(this.configOption.appKey,this),this.expConfig&&0!==this.expConfig.length?(this.shuntRes=z(this),this.log&&e("shunt successfully"),t&&t({res:{expConfig:this.expConfig,shuntRes:this.shuntRes,sdk:this},msg:"shunt successfully",status:!0})):t&&t({res:{expConfig:[],shuntRes:{},sdk:this},msg:"unknown exception",status:!1})):(t&&t({res:void 0,msg:"sdk not initialized",status:!1}),void(this.log&&e("sdk not initialized")))},resetInstance(){this.configOption={},this.log=!1,this.expConfig=[],this.timer&&clearTimeout(this.timer),this.timer=0,this.isInit=!1,this.shuntRes={},this.groupRes={}}},L=new Map;function Y(t,...e){let r="",s="";if(n(t)?r=t:(r=t.funcName,s=t.sdkKey),s){if(!L.get(s)&&"init"===r){const t=J(r,G,...e);return L.set(s,o(G)),t}return L.get(s)||"init"===r?J(r,L.get(s),...e):{res:{expConfig:{},shuntRes:{},sdk:L.get(s)},msg:"sdkKey does not exist"}}return J(r,G,...e)}const J=(t,e,...n)=>{if("start"===t||"refresh"===t)return new Promise((r=>{e[t].call(e,r,...n)}));if("init"!==t&&"resetInstance"!==t&&!G.isInit){const e={res:void 0,msg:"sdk not initialized",status:!1};return"getVar"===t&&n[2]&&r(n[2])&&n[2](e),e}return e[t]&&r(e[t])&&e[t].call(e,...n),e},$=async(t,n,r=c)=>{const s={appKey:t},i=await r(s);return i?(n.log&&e("The experimental parameters were successfully obtained"),i):(n.log&&e("Failed to get experimental parameters"),[])},Q=t=>{const e=t.configOption.autoRefreshStep;t.timer=setInterval((async()=>{t.refresh()}),e)};u(Promise.resolve().then((function(){return it})));var X,Z;!function(t){t.json="application/json;charset=UTF-8"}(X||(X={})),function(t){t.post="POST"}(Z||(Z={}));const et=t=>t&&void 0!==t["Content-Type"]?t["Content-Type"]:(t&&(t.method,Z.post),X.json),nt=t=>`http://47.96.100.195/api/${t.replace("//","/")}`,rt=(t,e)=>{const n=e&&void 0!==e.token?e.token:"",r="uni-app";return r===exports.ENV.MINI_WECHAT||r===exports.ENV.MINI_DOUYIN||r===exports.ENV.UNI_APP?{token:n,"Content-Type":t}:new Headers({token:n,"Content-Type":t})};const st=t=>t;var it=Object.freeze({__proto__:null,default:async(t,n={params:{},method:"POST",headers:{"Content-Type":X.json,token:""},token:"","Content-Type":X.json})=>{const{reqUrl:r,headers:s}=function(t,e){const n=et(e);return{contentType:n,reqUrl:nt(t),headers:rt(n,e)}}(t,n),i=await function(t,n,r){return new Promise(((s,i)=>{const o="uni-app";((t,e)=>{if(e===t.MINI_DOUYIN)return tt;if(e===t.MINI_WECHAT)return wx;if(e===t.UNI_APP)return uni})(exports.ENV,o).request({url:t,method:Z.post,data:r.params,header:{...n},success:t=>{200===t.statusCode?s(t.data):i(t)},fail:t=>{i(t),e(t.message)}})}))}(r,s,n);return st(i)}});exports.ABTest=(t,...e)=>Y(t,...e),exports.abTestGrouping=q,exports.abTestShunt=z,exports.autoRefresh=Q,exports.cbdABTest=Y,exports.deepCopy=o,exports.experimentConfig=c,exports.extend=t,exports.getExperimentConfig=$,exports.isArray=i,exports.isBool=t=>"boolean"==typeof t,exports.isEmptyObj=t=>"{}"===JSON.stringify(t),exports.isFunction=r,exports.isNumber=t=>"number"==typeof t,exports.isObject=s,exports.isString=n,exports.log=e,exports.mergeConfig=h,exports.sdk=G,exports.setConfig=function(t,e){Object.prototype.hasOwnProperty.call(p,t)?p[t]=e:p.customConfig[t]=e},exports.setRequestInst=u,exports.shuntAlgorithm=K;
